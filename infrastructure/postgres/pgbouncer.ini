;; PgBouncer Configuration for Personal Network CRM
;; Optimized for connection pooling and performance

[databases]
; Database connection strings
; Format: dbname = host=hostname port=port dbname=dbname

pmcrm = host=postgres port=5432 dbname=pmcrm
pmcrm_readonly = host=postgres-replica port=5432 dbname=pmcrm

[pgbouncer]
;;;
;;; Administrative settings
;;;

logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

;;;
;;; Where to wait for clients
;;;

; IP address or * which means all IPs
listen_addr = 0.0.0.0
listen_port = 6432

; Unix socket is also used for local connections
unix_socket_dir = /var/run/postgresql
unix_socket_mode = 0777
unix_socket_group = postgres

;;;
;;; TLS settings
;;;

; Enable TLS (recommended for production)
;client_tls_sslmode = require
;client_tls_key_file = /etc/pgbouncer/server.key
;client_tls_cert_file = /etc/pgbouncer/server.crt
;client_tls_ca_file = /etc/pgbouncer/ca.crt

;;;
;;; Authentication settings
;;;

; Use auth_file for user authentication
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

; Query to load user passwords
; auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

;;;
;;; Connection pooling settings
;;;

; Pool mode
; - session: server is released back to pool after client disconnects (default)
; - transaction: server is released back to pool after transaction finishes
; - statement: server is released back to pool after query finishes
pool_mode = transaction

; Maximum number of client connections allowed
max_client_conn = 1000

; Default pool size (per database/user pair)
default_pool_size = 25

; Minimum pool size (keep this many connections open)
min_pool_size = 5

; How many additional connections are allowed in pool
reserve_pool_size = 10

; If a client has been in "reserve pool" longer than this, close it
reserve_pool_timeout = 3

; Maximum number of server connections per database/user pair
max_db_connections = 100

; Maximum number of server connections per user
max_user_connections = 100

;;;
;;; Server connection settings
;;;

; Server connection timeout
server_connect_timeout = 15

; Server login retry delay
server_login_retry = 15

; Query wait timeout
query_wait_timeout = 120

; Server idle timeout (close idle server connections)
server_idle_timeout = 600

; Server lifetime (reconnect after this many seconds)
server_lifetime = 3600

; Check for server connections older than this
server_check_delay = 30

;;;
;;; Client connection settings
;;;

; Client idle timeout
client_idle_timeout = 0

; Client login timeout
client_login_timeout = 60

;;;
;;; Timeouts
;;;

; Close server connection if it has been idle for this long
; (use with care - may interfere with long-running transactions)
;idle_transaction_timeout = 600

; Kill queries that have been running longer than this
;query_timeout = 0

;;;
;;; Dangerous timeouts
;;;

; Abort queries running for this long
; query_timeout = 0

; Abort transactions running for this long
; idle_transaction_timeout = 0

;;;
;;; Low-level tuning options
;;;

; Buffer size for PostgreSQL packets
pkt_buf = 4096

; Maximum packet size from client
max_packet_size = 2147483647

; Accept only Unix socket connections
;listen_backlog = 128

; Disable Nagle algorithm for better latency
;tcp_socket_buffer = 0

; SO_KEEPALIVE settings
;tcp_keepalive = 1
;tcp_keepidle = 600
;tcp_keepintvl = 30
;tcp_keepcnt = 10

;;;
;;; DNS settings
;;;

; DNS zone refresh
;dns_max_ttl = 15
;dns_zone_check_period = 0

;;;
;;; Logging
;;;

; Log verbosity (0=quiet, 1=normal, 2=verbose, 3=debug)
verbose = 1

; Log all queries (for debugging)
;log_connections = 1
;log_disconnections = 1
;log_pooler_errors = 1

; Log stats every N seconds
stats_period = 60

;;;
;;; Connection sanity checks, timeouts
;;;

; Close server connection if it has been idle for this many seconds
server_reset_query = DISCARD ALL
server_reset_query_always = 0

; Check if server connection is still alive
server_check_query = SELECT 1

;;;
;;; Console access control
;;;

; Comma-separated list of users who are allowed to run all commands on console
admin_users = postgres, admin

; Comma-separated list of users who are allowed to run read-only queries on console
stats_users = stats, prometheus

;;;
;;; Application name
;;;

application_name_add_host = 1

;;;
;;; Performance optimization
;;;

; Use SO_REUSEPORT for better performance on multi-core systems
so_reuseport = 1

; Disable for better performance if you don't need it
;ignore_startup_parameters = extra_float_digits

;;;
;;; INCLUDE
;;;

; Include files from a directory
;%include /etc/pgbouncer/pgbouncer-other.ini
